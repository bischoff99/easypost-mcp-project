---
description: "Core coding standards and principles for this project"
globs: []
alwaysApply: true
---

# Core Project Standards

These standards apply to all code in this project.

## Type Safety

**Strict typing everywhere:**
```python
# Python: Type hints required
async def create_shipment(data: ShipmentCreate, ctx: Context = None) -> dict[str, Any]:
    pass

# JavaScript: Avoid any, unknown, generic types
const processData = (items: ShipmentData[]): ProcessedResult => {
    // Implementation
};
```

## Error Handling

**Always raise errors explicitly; never silently ignore failures:**

```python
# Good: Explicit error with context
try:
    result = await api_call()
except APIError as e:
    logger.error(f"API call failed: {str(e)}", extra={"context": data})
    raise HTTPException(status_code=502, detail=f"External API error: {str(e)}")

# Bad: Swallowed exception
try:
    result = await api_call()
except:
    pass  # Never do this!
```

**Error message requirements:**
- Clear and actionable
- Include context about what failed and why
- Use specific error types, not generic ones
- No fallback mechanisms that mask root causes

## Security

**Never compromise on security:**

```python
# Always validate inputs
def process_input(data: dict) -> ProcessedData:
    validated = InputSchema(**data)  # Pydantic validation
    return process(validated)

# Never hardcode secrets
API_KEY = os.getenv("EASYPOST_API_KEY")  # Good
# API_KEY = "pk_test_..." # Bad!

# Parameterized queries only
stmt = select(User).where(User.id == user_id)  # Good
# query = f"SELECT * FROM users WHERE id = {user_id}"  # Bad! SQL injection
```

**Security checklist:**
- [ ] All user inputs validated and sanitized
- [ ] Secrets in environment variables, never hardcoded
- [ ] Parameterized queries (never string concatenation)
- [ ] XSS prevention (React escaping)
- [ ] Principle of least privilege

## Documentation

**Document why, not what:**

```python
# Good: Explains why
async def retry_with_backoff(func, max_attempts=3):
    """
    Retry function with exponential backoff.

    EasyPost API has rate limits and occasional transient failures.
    Exponential backoff prevents overwhelming the API while allowing
    recovery from temporary issues.
    """
    pass

# Bad: States the obvious
async def retry_with_backoff(func, max_attempts=3):
    """Retries a function multiple times."""
    pass
```

**Documentation standards:**
- Python: Docstrings for all public functions (Args/Returns/Raises)
- JavaScript: JSDoc comments for exported functions
- Type hints for all function signatures
- Examples in comments when logic is non-obvious

## Code Quality

**Follow these principles:**

1. **DRY (Don't Repeat Yourself)**: Extract common logic
2. **KISS (Keep It Simple)**: Simple solutions over clever ones
3. **YAGNI (You Aren't Gonna Need It)**: Don't add unused features
4. **Single Responsibility**: Each function/class does one thing well
5. **Pure Functions**: Don't modify inputs or global state

```python
# Good: Pure function
def calculate_total(items: list[Item]) -> Decimal:
    return sum(item.price for item in items)

# Bad: Modifies input
def calculate_total(items: list[Item]) -> Decimal:
    total = Decimal(0)
    for item in items:
        item.processed = True  # Side effect!
        total += item.price
    return total
```

## Testing

**Write testable code:**

```python
# Good: Testable with dependency injection
async def create_shipment(data: dict, api_client: EasyPostClient) -> dict:
    return await api_client.create(data)

# Bad: Hard to test (hidden dependency)
async def create_shipment(data: dict) -> dict:
    client = EasyPostClient()  # Can't mock this!
    return await client.create(data)
```

**Testing requirements:**
- 80%+ coverage on critical paths
- Mock external dependencies (EasyPost API, database)
- Use AAA pattern (Arrange, Act, Assert)
- Table-driven tests for parametric testing

## Performance

**Profile before optimizing:**

```python
# Don't optimize prematurely
# Profile first, then optimize hot paths

# Good: Profile-guided optimization
@profile  # Use profiler to identify bottleneck
async def process_batch(items):
    # Optimize only after profiling shows this is slow
    pass
```

**Common performance patterns:**
- Use async/await for I/O operations
- Implement caching for frequently accessed data
- Lazy load large datasets
- Avoid N+1 queries (use eager loading)
- Batch operations where possible

## Version Control

**Commit conventions:**

```bash
# Format: type(scope): description

feat: add bulk shipment creation endpoint
fix: resolve tracking number validation bug
docs: update API documentation
refactor: extract address validation logic
test: add tests for rate calculation
chore: update dependencies
```

**Commit best practices:**
- Atomic commits (one logical change per commit)
- Reference issue numbers when relevant
- Keep PRs focused; avoid mixing concerns
- Write commit messages that explain why, not what

## Dependencies

**Manage dependencies properly:**

```bash
# Always use virtual environments
python -m venv venv  # Good
pip install requests # Bad (global install)

# Pin versions in requirements.txt
fastapi==0.104.0  # Good
fastapi>=0.104.0  # Acceptable
fastapi           # Bad (unpredictable)
```

**Dependency checklist:**
- [ ] Installed in virtual environment
- [ ] Added to requirements.txt or package.json
- [ ] Version pinned or ranged (not wildcards)
- [ ] Package is actively maintained
- [ ] Alternatives considered

## Architecture

**Respect existing patterns:**

```python
# Follow the established pattern in this codebase:
# - Services for business logic (services/)
# - Routers for API endpoints (routers/)
# - Models for data structures (models/)
# - Utils for helpers (utils/)

# Don't introduce new patterns without discussion
```

**Design principles:**
- Prefer composition over inheritance
- Keep modules small and focused
- Use dependency injection for testability
- Separate concerns (business logic â‰  presentation)

---

**Remember**: These are project-wide standards. More specific guidance in:
- `01-fastapi-python.mdc` for backend
- `02-react-vite-frontend.mdc` for frontend
- `03-testing-best-practices.mdc` for testing
- `04-mcp-development.mdc` for MCP tools
- `05-m3-max-optimizations.mdc` for performance
