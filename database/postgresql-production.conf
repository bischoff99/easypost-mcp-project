# PostgreSQL Configuration for Production (M3 Max - 64GB RAM, 14 performance cores)
# Based on best practices from PostgreSQL docs, pgTune, and community recommendations
#
# Apply with: ALTER SYSTEM SET parameter = value;
# Or include in postgresql.conf: include = '/path/to/postgresql-production.conf'

# ============================================================================
# MEMORY SETTINGS (64GB RAM)
# ============================================================================

# Shared memory for caching data and indexes (25% of RAM)
shared_buffers = 16GB

# Estimated memory available for disk caching (75% of RAM)
effective_cache_size = 48GB

# Memory for sorts and hash operations per operation
# Formula: RAM / max_connections / 2
work_mem = 64MB

# Memory for maintenance operations (VACUUM, CREATE INDEX, etc.)
maintenance_work_mem = 2GB

# ============================================================================
# PARALLEL QUERY SETTINGS (M3 Max: 14 performance cores)
# ============================================================================

# Maximum number of background worker processes
max_worker_processes = 14

# Maximum workers per parallel query
max_parallel_workers_per_gather = 4

# Maximum workers for maintenance operations
max_parallel_maintenance_workers = 4

# Maximum total parallel workers system-wide
max_parallel_workers = 14

# ============================================================================
# ASYNC I/O SETTINGS (NVMe SSD)
# ============================================================================

# Number of concurrent disk I/O operations (NVMe SSD = 200+)
effective_io_concurrency = 200

# I/O concurrency for maintenance operations
maintenance_io_concurrency = 200

# ============================================================================
# WAL (Write-Ahead Logging) SETTINGS
# ============================================================================

# Size of WAL buffers (auto-tuned if set to -1)
wal_buffers = 16MB

# Checkpoint completion target (0.9 = smoother checkpoints)
checkpoint_completion_target = 0.9

# Maximum size of WAL between automatic checkpoints
max_wal_size = 4GB

# Minimum size of WAL to keep for checkpoint distance
min_wal_size = 1GB

# ============================================================================
# QUERY PLANNER SETTINGS
# ============================================================================

# Random page cost (lower for SSD, default is 4.0)
random_page_cost = 1.1

# Cost of processing each row during query execution
cpu_tuple_cost = 0.01

# Cost of processing each index entry
cpu_index_tuple_cost = 0.005

# Cost of processing each operator or function
cpu_operator_cost = 0.0025

# Minimum size of table for parallel scan (8MB)
min_parallel_table_scan_size = 8MB

# Minimum size of index for parallel scan (512kB)
min_parallel_index_scan_size = 512kB

# ============================================================================
# CONNECTION SETTINGS
# ============================================================================

# Maximum number of concurrent connections
max_connections = 100

# ============================================================================
# LOGGING & MONITORING
# ============================================================================

# Log queries slower than this threshold (1 second)
log_min_duration_statement = 1000

# Log checkpoint activity
log_checkpoints = on

# Log connections
log_connections = on

# Log disconnections
log_disconnections = on

# Log duration of each completed SQL statement
log_duration = off

# Log lock waits longer than deadlock_timeout
log_lock_waits = on

# ============================================================================
# PERFORMANCE EXTENSIONS
# ============================================================================

# Enable JIT compilation (PostgreSQL 11+)
jit = on

# Load pg_stat_statements for query performance monitoring
shared_preload_libraries = 'pg_stat_statements'

# pg_stat_statements settings
pg_stat_statements.max = 10000
pg_stat_statements.track = all

# ============================================================================
# AUTOVACUUM TUNING
# ============================================================================

# Enable autovacuum
autovacuum = on

# Maximum autovacuum workers
autovacuum_max_workers = 4

# Delay between autovacuum runs
autovacuum_naptime = 15s

# Vacuum when 2% of table has changed
autovacuum_vacuum_scale_factor = 0.02

# Analyze when 1% of table has changed
autovacuum_analyze_scale_factor = 0.01

# ============================================================================
# NOTES
# ============================================================================
# 
# Apply these settings:
# 1. Copy to PostgreSQL data directory
# 2. Add to postgresql.conf: include = 'postgresql-production.conf'
# 3. Restart PostgreSQL: pg_ctl restart
# 4. Verify with: SHOW ALL;
#
# Monitor performance:
# - pg_stat_statements for slow queries
# - pg_stat_activity for active connections
# - pg_stat_database for database statistics

