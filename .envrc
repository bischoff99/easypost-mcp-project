# Auto-load environment variables
# Install: brew install direnv
# Activate: eval "$(direnv hook zsh)"

# NOTE: Using venv at project root instead of direnv's layout python
# This ensures consistent Python environment across all tools (Makefile, scripts, etc.)
# If you want to use direnv's layout python instead, uncomment the line below
# and remove the PATH_add venv/bin line
# layout python python3

# Load .env file (single source of truth at project root)
dotenv_if_exists .env

# Load environment-specific .env files from config/
dotenv_if_exists config/.env
if [ "$ENVIRONMENT" = "test" ]; then
    dotenv_if_exists config/.env.test
elif [ "$ENVIRONMENT" = "production" ]; then
    dotenv_if_exists config/.env.production
else
    # Default to test environment for development
    dotenv_if_exists config/.env.test
fi

# Load EasyPost API key from Keychain based on environment
if [ -z "$EASYPOST_API_KEY" ]; then
    if [ "$ENVIRONMENT" = "production" ]; then
        export EASYPOST_API_KEY=$(security find-generic-password -s "easypost-prod" -w 2>/dev/null)
    else
        # Default to test key for development/test
        export EASYPOST_API_KEY=$(security find-generic-password -s "easypost-test" -w 2>/dev/null)
    fi
fi

# Add local bin to PATH
PATH_add venv/bin

# Export common vars
export PYTHONPATH="${PWD}/src:${PYTHONPATH}"
# ENVIRONMENT is now controlled by .env files, don't override

# Allow direnv
# Run: direnv allow
